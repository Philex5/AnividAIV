# R2 å­˜å‚¨æ–‡ä»¶å¤¹åˆ é™¤å·¥å…·

## ç®€ä»‹

è¿™ä¸ªå·¥å…·ç”¨äºåˆ é™¤ Cloudflare R2 å­˜å‚¨ä¸­æŒ‡å®šæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ•°æ®ã€‚æ”¯æŒ development å’Œ production ä¸¤ä¸ªç¯å¢ƒï¼Œå¹¶æä¾›é¢„è§ˆæ¨¡å¼ä»¥ç¡®ä¿åˆ é™¤æ“ä½œçš„å®‰å…¨æ€§ã€‚

## åŠŸèƒ½ç‰¹æ€§

- âœ… æ”¯æŒå¤šç¯å¢ƒï¼ˆdevelopment / productionï¼‰
- âœ… é¢„è§ˆæ¨¡å¼ï¼ˆ--dry-runï¼‰- å…ˆæŸ¥çœ‹è¦åˆ é™¤çš„å¯¹è±¡ä½†ä¸å®é™…åˆ é™¤
- âœ… åˆ†æ‰¹åˆ é™¤ - é¿å…å•æ¬¡è¯·æ±‚è¿‡è½½ï¼ˆé»˜è®¤ 1000 ä¸ªå¯¹è±¡/æ‰¹ï¼‰
- âœ… è¯¦ç»†çš„åˆ é™¤æŠ¥å‘Š - æ˜¾ç¤ºæˆåŠŸ/å¤±è´¥çš„å¯¹è±¡æ•°é‡
- âœ… äº¤äº’å¼ç¡®è®¤ - ç”Ÿäº§ç¯å¢ƒä¸‹éœ€è¦è¾“å…¥ 'YES' ç¡®è®¤
- âœ… è‡ªåŠ¨åŠ è½½å¯¹åº”ç¯å¢ƒçš„ .env é…ç½®æ–‡ä»¶

## ä½¿ç”¨æ–¹æ³•

### å‘½ä»¤è¯­æ³•

```bash
# ä½¿ç”¨ tsx ç›´æ¥è¿è¡Œ
tsx scripts/delete-r2-folder.ts --env <environment> --folder <folder-path> [é€‰é¡¹]

# æˆ–ä½¿ç”¨ package.json ä¸­çš„å¿«æ·å‘½ä»¤
pnpm r2:delete:dev --folder <folder-path>
pnpm r2:delete:prod --folder <folder-path>
```

### å‚æ•°è¯´æ˜

| å‚æ•° | è¯´æ˜ | æ˜¯å¦å¿…éœ€ | ç¤ºä¾‹ |
|------|------|----------|------|
| `--env` | æŒ‡å®šç¯å¢ƒï¼ˆdevelopment æˆ– productionï¼‰ | âœ… | `--env production` |
| `--folder` | è¦åˆ é™¤çš„æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆç›¸å¯¹äº bucket æ ¹ç›®å½•ï¼‰ | âœ… | `--folder user-uploads/123456` |
| `--dry-run` | é¢„è§ˆæ¨¡å¼ï¼Œä»…æ˜¾ç¤ºè¦åˆ é™¤çš„å¯¹è±¡ä½†ä¸å®é™…åˆ é™¤ | âŒ | `--dry-run` |
| `--batch-size` | æ‰¹é‡åˆ é™¤çš„å¤§å°ï¼Œé»˜è®¤ 1000 | âŒ | `--batch-size 500` |
| `--help, -h` | æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ | âŒ | `--help` |

### ç¤ºä¾‹

#### 1. é¢„è§ˆè¦åˆ é™¤çš„å¯¹è±¡ï¼ˆæ¨èå…ˆæ‰§è¡Œï¼‰

```bash
# é¢„è§ˆåˆ é™¤ development ç¯å¢ƒçš„æŸä¸ªæ–‡ä»¶å¤¹
tsx scripts/delete-r2-folder.ts --env development --folder temp-files --dry-run

# æˆ–ä½¿ç”¨å¿«æ·å‘½ä»¤
pnpm r2:delete:dev --folder temp-files --dry-run
```

#### 2. å®é™…åˆ é™¤å¯¹è±¡

```bash
# åˆ é™¤ development ç¯å¢ƒçš„ user-uploads/123456 æ–‡ä»¶å¤¹
tsx scripts/delete-r2-folder.ts --env development --folder user-uploads/123456

# åˆ é™¤ production ç¯å¢ƒçš„æŸä¸ªæ–‡ä»¶å¤¹
tsx scripts/delete-r2-folder.ts --env production --folder old-backups/2024
```

#### 3. è‡ªå®šä¹‰æ‰¹é‡å¤§å°

```bash
# ä½¿ç”¨è¾ƒå°çš„æ‰¹é‡å¤§å°
tsx scripts/delete-r2-folder.ts --env production --folder large-folder --batch-size 100
```

## å®é™…ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šæ¸…ç†ä¸´æ—¶æ–‡ä»¶

```bash
# åˆ é™¤ development ç¯å¢ƒçš„ä¸´æ—¶ä¸Šä¼ æ–‡ä»¶
tsx scripts/delete-r2-folder.ts --env development --folder temp-uploads
```

### åœºæ™¯ 2ï¼šåˆ é™¤ç”¨æˆ·ç”Ÿæˆçš„å†…å®¹

```bash
# å½“ç”¨æˆ·åˆ é™¤è´¦æˆ·æ—¶ï¼Œåˆ é™¤å…¶æ‰€æœ‰ç”Ÿæˆçš„å†…å®¹
tsx scripts/delete-r2-folder.ts --env production --folder user-content/user123
```

### åœºæ™¯ 3ï¼šæ¸…ç†è¿‡æœŸæ•°æ®

```bash
# åˆ é™¤ 30 å¤©å‰çš„ç¼“å­˜æ–‡ä»¶
tsx scripts/delete-r2-folder.ts --env production --folder cache/2024-01
```

### åœºæ™¯ 4ï¼šæ¸…ç†æµ‹è¯•æ•°æ®

```bash
# åœ¨æµ‹è¯•ç¯å¢ƒä¸­æ¸…ç†æµ‹è¯•æ•°æ®
tsx scripts/delete-r2-folder.ts --env development --folder test-data/batch-123
```

## æ“ä½œæµç¨‹

1. **åŠ è½½ç¯å¢ƒé…ç½®**ï¼šè„šæœ¬ä¼šè‡ªåŠ¨åŠ è½½ `.env.development` æˆ– `.env.production` æ–‡ä»¶
2. **éªŒè¯é…ç½®**ï¼šæ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡ï¼ˆendpoint, access key, secret key, bucketï¼‰
3. **åˆ—å‡ºå¯¹è±¡**ï¼šæ‰«ææŒ‡å®šæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰å¯¹è±¡
4. **é¢„è§ˆ/ç¡®è®¤**ï¼š
   - é¢„è§ˆæ¨¡å¼ï¼šç›´æ¥æ˜¾ç¤ºå¯¹è±¡åˆ—è¡¨
   - ç”Ÿäº§æ¨¡å¼ï¼šæ˜¾ç¤ºå¯¹è±¡åˆ—è¡¨å¹¶è¦æ±‚è¾“å…¥ 'YES' ç¡®è®¤
5. **æ‰§è¡Œåˆ é™¤**ï¼š
   - åˆ†æ‰¹åˆ é™¤å¯¹è±¡ï¼ˆæ¯æ‰¹æœ€å¤š 1000 ä¸ªï¼‰
   - æ˜¾ç¤ºåˆ é™¤è¿›åº¦å’Œç»“æœ
6. **ç”ŸæˆæŠ¥å‘Š**ï¼šæ˜¾ç¤ºæˆåŠŸåˆ é™¤å’Œå¤±è´¥çš„å¯¹è±¡æ•°é‡

## æ³¨æ„äº‹é¡¹

âš ï¸ **é‡è¦æé†’**ï¼š

1. **åˆ é™¤æ˜¯ä¸å¯é€†æ“ä½œ**ï¼šä¸€æ—¦åˆ é™¤ï¼Œæ— æ³•æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œï¼
2. **æ¨èä½¿ç”¨é¢„è§ˆæ¨¡å¼**ï¼šç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ä½¿ç”¨ `--dry-run` é¢„è§ˆè¦åˆ é™¤çš„å¯¹è±¡
3. **ç”Ÿäº§ç¯å¢ƒç¡®è®¤**ï¼šç”Ÿäº§ç¯å¢ƒåˆ é™¤éœ€è¦è¾“å…¥ 'YES' ç¡®è®¤
4. **æ‰¹é‡é™åˆ¶**ï¼šAWS S3 API æ¯æ¬¡æœ€å¤šåˆ é™¤ 1000 ä¸ªå¯¹è±¡ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨åˆ†æ‰¹å¤„ç†
5. **æƒé™è¦æ±‚**ï¼šéœ€è¦ R2 å­˜å‚¨çš„è¯»å†™æƒé™
6. **ç½‘ç»œç¨³å®šæ€§**ï¼šåˆ é™¤å¤§é‡å¯¹è±¡æ—¶ï¼Œè¯·ç¡®ä¿ç½‘ç»œè¿æ¥ç¨³å®š

## ç¯å¢ƒé…ç½®

### Development ç¯å¢ƒé…ç½®

`.env.development` æ–‡ä»¶ä¸­çš„ç›¸å…³é…ç½®ï¼š

```env
STORAGE_ENDPOINT=https://37cc7953cbc0d25d9bca7f7c0b307108.r2.cloudflarestorage.com
STORAGE_REGION=auto
STORAGE_ACCESS_KEY=your_access_key
STORAGE_SECRET_KEY=your_secret_key
STORAGE_BUCKET=aiiconsetdev
STORAGE_DOMAIN=https://test-icons.sparkiconai.com
```

### Production ç¯å¢ƒé…ç½®

`.env.production` æ–‡ä»¶ä¸­çš„ç›¸å…³é…ç½®ï¼š

```env
STORAGE_ENDPOINT=
STORAGE_REGION=
STORAGE_ACCESS_KEY=2ed367b3f7ff2b19156230c867c59909
STORAGE_SECRET_KEY=6f2c33f2d4dc0b834af3afa18dd6749ff658000c70124d0a329d8648da5f14a5
STORAGE_BUCKET=anividai-prod
STORAGE_DOMAIN=https://artworks.anividai.com
```

## é”™è¯¯å¤„ç†

è„šæœ¬ä¼šæ•è·å¹¶æ˜¾ç¤ºä»¥ä¸‹ç±»å‹çš„é”™è¯¯ï¼š

- **ç¯å¢ƒæ–‡ä»¶ä¸å­˜åœ¨**ï¼šæŒ‡å®šçš„ `.env.development` æˆ– `.env.production` æ–‡ä»¶ä¸å­˜åœ¨
- **ç¼ºå°‘ç¯å¢ƒå˜é‡**ï¼šSTORAGE_ENDPOINTã€STORAGE_ACCESS_KEY ç­‰å¿…éœ€å˜é‡ç¼ºå¤±
- **æƒé™é”™è¯¯**ï¼šR2 å­˜å‚¨æƒé™ä¸è¶³
- **ç½‘ç»œé”™è¯¯**ï¼šAPI è¯·æ±‚å¤±è´¥
- **å¯¹è±¡ä¸å­˜åœ¨**ï¼šå°è¯•åˆ é™¤ä¸å­˜åœ¨çš„å¯¹è±¡

æ‰€æœ‰é”™è¯¯éƒ½ä¼šæ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼Œå¸®åŠ©å¿«é€Ÿå®šä½é—®é¢˜ã€‚

## è¾“å‡ºç¤ºä¾‹

### é¢„è§ˆæ¨¡å¼è¾“å‡º

```
ğŸ—‘ï¸  R2 æ–‡ä»¶å¤¹åˆ é™¤å·¥å…·
==================================================
ğŸ“¦ ç¯å¢ƒ: development
ğŸ“ æ–‡ä»¶å¤¹: temp-files/
ğŸ” é¢„è§ˆæ¨¡å¼: å¼€å¯
==================================================

âœ… å·²åŠ è½½ç¯å¢ƒæ–‡ä»¶: .env.development

ğŸ”— å­˜å‚¨é…ç½®:
   Endpoint: https://...r2.cloudflarestorage.com
   Bucket: aiiconsetdev
   Domain: https://test-icons.sparkiconai.com

ğŸ” æ‰«ææ–‡ä»¶å¤¹: temp-files/

ğŸ“‹ æ­£åœ¨åˆ—å‡ºæ‰€æœ‰å¯¹è±¡...
   æ‰¾åˆ° 25 ä¸ªå¯¹è±¡

ğŸ“ å¯¹è±¡åˆ—è¡¨ï¼ˆå‰ 20 ä¸ªï¼‰:
   1. temp-files/image1.jpg
   2. temp-files/image2.png
   3. temp-files/data.json
   ...

âœ… é¢„è§ˆæ¨¡å¼ - æœªå®é™…åˆ é™¤å¯¹è±¡
```

### å®é™…åˆ é™¤è¾“å‡º

```
ğŸ—‘ï¸  R2 æ–‡ä»¶å¤¹åˆ é™¤å·¥å…·
==================================================
ğŸ“¦ ç¯å¢ƒ: production
ğŸ“ æ–‡ä»¶å¤¹: old-data/
ğŸ” é¢„è§ˆæ¨¡å¼: å…³é—­
==================================================

âœ… å·²åŠ è½½ç¯å¢ƒæ–‡ä»¶: .env.production

ğŸ”— å­˜å‚¨é…ç½®:
   Endpoint: https://...r2.cloudflarestorage.com
   Bucket: anividai-prod
   Domain: https://artworks.anividai.com

ğŸ” æ‰«ææ–‡ä»¶å¤¹: old-data/

ğŸ“‹ æ­£åœ¨åˆ—å‡ºæ‰€æœ‰å¯¹è±¡...
   æ‰¾åˆ° 1500 ä¸ªå¯¹è±¡

ğŸ“ å¯¹è±¡åˆ—è¡¨ï¼ˆå‰ 20 ä¸ªï¼‰:
   1. old-data/file1.txt
   2. old-data/file2.txt
   ...

âš ï¸  ç¡®è®¤åˆ é™¤ 1500 ä¸ªå¯¹è±¡å—ï¼Ÿ(è¾“å…¥ 'YES' ç¡®è®¤): YES

ğŸ—‘ï¸  æ­£åœ¨åˆ é™¤å¯¹è±¡...

ğŸ“¦ å¤„ç†æ‰¹æ¬¡ 1/2 (1000 ä¸ªå¯¹è±¡)
   âœ… æˆåŠŸåˆ é™¤: 1000 ä¸ªå¯¹è±¡

ğŸ“¦ å¤„ç†æ‰¹æ¬¡ 2/2 (500 ä¸ªå¯¹è±¡)
   âœ… æˆåŠŸåˆ é™¤: 500 ä¸ªå¯¹è±¡

==================================================
ğŸ“Š åˆ é™¤ç»“æœ:
   âœ… æˆåŠŸåˆ é™¤: 1500 ä¸ªå¯¹è±¡
   âŒ åˆ é™¤å¤±è´¥: 0 ä¸ªå¯¹è±¡
   ğŸ“¦ æ€»è®¡å¤„ç†: 1500 ä¸ªå¯¹è±¡
==================================================

âœ… æ“ä½œå®Œæˆ
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**Q: æç¤º "Bucket is required" é”™è¯¯ï¼Ÿ**
A: æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ `STORAGE_BUCKET` æ˜¯å¦è®¾ç½®æ­£ç¡®ã€‚

**Q: æç¤º "List objects failed" é”™è¯¯ï¼Ÿ**
A: æ£€æŸ¥ R2 çš„ endpointã€access key å’Œ secret key æ˜¯å¦æ­£ç¡®ï¼Œå¹¶ç¡®ä¿æœ‰ list æƒé™ã€‚

**Q: åˆ é™¤å¤±è´¥ä½†æ²¡æœ‰é”™è¯¯ä¿¡æ¯ï¼Ÿ**
A: ä½¿ç”¨ `--dry-run` å…ˆé¢„è§ˆå¯¹è±¡ï¼Œç¡®è®¤å¯¹è±¡ç¡®å®å­˜åœ¨ã€‚

**Q: è„šæœ¬æ‰§è¡Œå¾ˆæ…¢ï¼Ÿ**
A: å¯¹äºå¤§é‡å¯¹è±¡ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡ã€‚å¯ä»¥ä½¿ç”¨ `--batch-size` å‚æ•°è°ƒæ•´æ‰¹é‡å¤§å°ï¼ˆå¦‚ 500 æˆ– 100ï¼‰ã€‚

## ç›¸å…³æ–‡æ¡£

- [Cloudflare R2 æ–‡æ¡£](https://developers.cloudflare.com/r2/)
- [AWS S3 API å…¼å®¹æ€§](https://developers.cloudflare.com/r2/api/s3/api/)

## è®¸å¯è¯

æœ¬å·¥å…·éµå¾ªé¡¹ç›®è®¸å¯è¯ã€‚