# 支付流程 - 场景测试

## 测试目标

验证购买积分和订阅会员的完整支付流程。

## 前置条件

- [x] 服务已启动
- [x] 已登录测试账号
- [x] Stripe/Creem 测试模式已配置

## 核心测试场景

### 场景 1: 查看定价页面

- [x] 打开定价页面 `/pricing`
- [x] 查看积分包列表
- [x] 查看会员订阅选项
- [x] 验证价格显示正确

### 场景 2: 购买积分（Stripe）

- [x] 选择一个积分包（如 100 MC）10 30 50 pag
- [x] 点击"购买"按钮
- [x] 跳转到 Stripe 支付页面
- [x] 使用测试卡号: `4242 4242 4242 4242`
- [x] 填写其他信息并支付
- [x] 验证支付成功回调
- [x] 验证积分到账

### 场景 3: 购买积分（Creem - 国内支付）

- [ ] 选择积分包
- [ ] 选择 Creem 支付方式
- [ ] 跳转到 Creem 支付页面
- [ ] 完成支付（测试模式）
- [ ] 验证支付成功
- [ ] 验证积分到账

### 场景 4: 订阅 VIP 会员

- [x] 选择会员套餐（月付）
- [x] 选择会员套餐（年付）
- [x] 点击"订阅"按钮
- [x] 完成支付流程
- [x] 验证订阅激活
- [x] 验证会员权益生效（OC 限额增加、积分赠送等）

### 场景 5: 查看订阅详情

- [x] 打开用户中心 `/user-center`
- [x] 查看"我的订阅"标签
- [x] 验证订阅信息: 套餐、开始日期、下次扣款日期
- [x] 验证订阅状态: active

### 场景 6: 取消订阅

- [x] 点击"取消订阅"按钮
- [x] 确认取消
- [x] 验证订阅状态变为: canceled
- [x] 验证订阅有效期至周期结束

### 场景 7: 订阅退款

- [ ] 查看退款预览
- [ ] 请求退款
- [ ] 验证退款金额
- [ ] 验证订阅取消

### 场景 8: 查看我的订单

- [x] 打开"我的订单"标签
- [x] 查看历史订单列表
- [x] 验证订单信息: 产品、金额、状态、日期

### 场景 9: 计费门户 (不涉及)

- [ ] 点击"管理订阅"按钮
- [ ] 跳转到 Stripe 计费门户
- [ ] 查看发票历史
- [ ] 更新支付方式

### 场景 10: 支付失败处理

- [x] 使用失败的测试卡号: `4000 0000 0000 0002`
- [x] 验证支付失败提示
- [ ] 验证订单状态为失败
- [ ] 验证积分未到账

### 场景 11: Webhook 处理

验证以下 Webhook 事件:

- [x] 支付成功 (invoice.payment_succeeded)
- [x] 订阅更新 (customer.subscription.updated)
- [x] 订阅取消 (customer.subscription.deleted) 跟新
- [x] 退款成功 (charge.refunded)

### 场景 12： 续费

- [x] 订阅更新 (customer.subscription.updated) 更新subscription_logs
- [x] 支付成功 (invoice.payment_succeeded) 更新 orders, users, subscriptions,credits
- [x]

### 场景 13: 邀请返利 (暂不涉及)

- [ ] 使用邀请码购买积分
- [ ] 验证邀请人获得返利
- [ ] 验证返利记录

## 测试数据

### Stripe 测试卡

- 成功: `4242 4242 4242 4242`
- 失败: `4000 0000 0000 0002`
- 需要 3D 验证: `4000 0025 0000 3155`

### 测试金额

建议使用小额测试避免实际扣费。

## 相关文档

- API: `docs/2-implementation/api/payments.md`, `subscriptions.md`
- 功能: `docs/2-implementation/features/feature-subscription.md`

## 变更历史

- 2025-11-12 初始版本
